<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YtMusic</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/?size=100&id=YNioBT5SxQw3&format=png&color=000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #282828; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #121212; }
        
        .queue-item.active { background-color: #212121; border-left: 3px solid #ef4444; padding-left: 5px; }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.1); border-left-color: #ef4444; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .mobile-progress-container { position: absolute; top: -2px; left: 0; width: 100%; height: 2px; background: #4d4d4d; cursor: pointer; }
        .mobile-progress-bar { height: 100%; background: #ef4444; }
        
        .video-hidden { opacity: 0; pointer-events: none; z-index: -10; }
        .video-visible { opacity: 1; pointer-events: auto; z-index: 50; }
        
        .heart-btn { transition: all 0.2s ease; }
        .heart-btn.loved { color: #ef4444; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .heart-animate { animation: heartbeat 0.3s ease; }
        
        .nav-item { transition: all 0.2s ease; }
        .nav-item.active { background: #212121; color: white; font-weight: 600; }
        
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }
    </style>
</head>
<body class="bg-[#0f0f0f] text-white h-screen flex flex-col">
    <div id="video-wrapper" class="fixed bottom-24 right-4 shadow-2xl rounded-lg overflow-hidden w-64 sm:w-80 aspect-video bg-black border border-[#333] video-hidden transition-all duration-300">
        <div id="yt-player"></div>
        <button id="hide-video-btn" class="absolute top-2 right-2 bg-black/50 hover:bg-black/80 text-white p-1 rounded-full">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <div class="flex flex-1 overflow-hidden pb-16 sm:pb-20">
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 hidden"></div>
        
        <aside id="sidebar" class="fixed sm:relative w-60 bg-[#0f0f0f] flex flex-col p-4 border-r border-[#212121] h-full z-30 transform -translate-x-full sm:translate-x-0 transition-transform duration-300">
            <div class="flex items-center justify-between mb-8 px-2">
                <div class="flex items-center space-x-2">
                    <img src="https://img.icons8.com/?size=100&id=YNioBT5SxQw3&format=png&color=000000" class="w-8 h-8">
                    <span class="text-xl font-bold tracking-tighter">Music</span>
                </div>
                <button id="close-sidebar-btn" class="sm:hidden text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <nav class="space-y-1">
                <a href="#" id="nav-home" class="nav-item flex items-center space-x-4 p-3 rounded-lg text-gray-400 hover:bg-[#212121] active">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span>Home</span>
                </a>
                <a href="#" id="nav-explore" class="nav-item flex items-center space-x-4 p-3 rounded-lg text-gray-400 hover:bg-[#212121]">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z"/></svg><span>Explore</span>
                </a>
                <a href="#" id="nav-favorites" class="nav-item flex items-center space-x-4 p-3 rounded-lg text-gray-400 hover:bg-[#212121]">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span>Favorites</span>
                </a>
            </nav>
        </aside>

        <main class="flex-1 flex flex-col bg-[#030303] overflow-hidden">
            <header class="h-16 flex items-center px-4 sticky top-0 z-10 bg-[#030303]/95 backdrop-blur border-b border-[#212121]">
                <div class="flex items-center w-full space-x-3">
                    <button id="menu-btn" class="text-white hover:bg-[#212121] p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="relative flex-1 max-w-2xl">
                        <input type="text" id="search-input" placeholder="Search songs, artists..." class="w-full bg-[#212121] text-white rounded-full py-2.5 pl-11 pr-4 focus:outline-none focus:ring-2 focus:ring-red-500/50 placeholder-gray-500 transition">
                        <svg class="w-5 h-5 text-gray-500 absolute left-4 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-sm font-bold flex-shrink-0">U</div>
                </div>
            </header>

            <section class="flex-1 overflow-y-auto custom-scrollbar p-4 sm:p-8" id="content-section"></section>
        </main>
    </div>

    <footer id="player-bar" class="fixed bottom-0 left-0 w-full bg-[#212121] border-t border-[#333] z-40 h-16 sm:h-20">
        <div class="block sm:hidden mobile-progress-container" id="mobile-progress-container">
            <div id="mobile-progress-bar" class="mobile-progress-bar" style="width: 0%"></div>
        </div>
        <div class="flex items-center justify-between h-full px-2 sm:px-4">
            <div class="flex items-center flex-1 min-w-0 mr-2">
                <button id="mobile-prev-btn" class="sm:hidden text-gray-300 p-2 mr-1"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <img id="player-art" src="https://placehold.co/48x48/333/666?text=Music" class="w-10 h-10 sm:w-12 sm:h-12 rounded bg-gray-800 object-cover flex-shrink-0">
                <div class="ml-3 overflow-hidden flex-1">
                    <p id="player-title" class="text-sm sm:text-base font-medium truncate text-white">Ready to play</p>
                    <p id="player-artist" class="text-xs sm:text-sm text-gray-400 truncate">Select a song</p>
                </div>
                <button id="love-btn" class="heart-btn hidden sm:block ml-2 text-gray-400 hover:text-red-500 p-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
            </div>
            <div class="hidden sm:flex flex-col items-center flex-1 max-w-xl">
                <div class="flex items-center space-x-6 mb-1">
                    <button id="prev-btn" class="text-gray-400 hover:text-white disabled:opacity-30"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                    <button id="play-pause-btn" class="bg-white text-black rounded-full p-2 hover:scale-105 transition transform"><svg id="play-icon-desktop" class="w-8 h-8 pl-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                    <button id="next-btn" class="text-gray-400 hover:text-white disabled:opacity-30"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM7 18l8.5-6L7 6z"/></svg></button>
                </div>
                <div class="w-full flex items-center space-x-2 text-xs text-gray-400">
                    <span id="current-time">0:00</span>
                    <div id="desktop-progress-container" class="relative flex-1 h-1 bg-gray-600 rounded cursor-pointer group">
                        <div id="desktop-progress-bar" class="absolute h-full bg-red-500 rounded w-0"></div>
                        <div class="absolute h-3 w-3 bg-white rounded-full -top-1 opacity-0 group-hover:opacity-100 transition-opacity" style="left: 0%" id="desktop-progress-thumb"></div>
                    </div>
                    <span id="total-duration">0:00</span>
                </div>
            </div>
            <div class="flex items-center justify-end space-x-2 sm:space-x-4 flex-1 sm:flex-none">
                <button id="mobile-play-btn" class="sm:hidden p-2 text-white"><svg id="play-icon-mobile" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button id="mobile-next-btn" class="sm:hidden p-2 text-gray-300"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM7 18l8.5-6L7 6z"/></svg></button>
                <button id="mobile-love-btn" class="heart-btn sm:hidden text-gray-400 hover:text-red-500">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
                <button id="toggle-video-btn" class="text-gray-400 hover:text-red-500 transition" title="Toggle Video">
                    <span class="text-xs font-bold border border-current px-1.5 py-0.5 rounded">VIDEO</span>
                </button>
                <button id="queue-btn" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg></button>
            </div>
        </div>
    </footer>

    <div id="queue-panel" class="fixed top-0 right-0 h-full w-full sm:w-96 bg-[#030303] border-l border-[#333] z-30 transform translate-x-full transition-transform duration-300 overflow-hidden shadow-2xl flex flex-col">
        <div class="px-4 py-4 flex items-center justify-between border-b border-[#212121] bg-[#030303] flex-shrink-0">
            <div>
                <h3 class="font-bold text-xl">Up Next</h3>
                <p class="text-xs text-gray-400 mt-0.5" id="queue-count">0 songs in queue</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="clear-queue-btn" class="text-gray-400 hover:text-red-500 text-xs font-medium px-3 py-1.5 rounded-lg hover:bg-[#212121] transition" title="Clear Queue">
                    Clear
                </button>
                <button id="close-queue-btn" class="text-gray-400 hover:text-white p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div id="queue-list" class="p-2">
                <p class="text-gray-500 text-center mt-10">Queue is empty</p>
            </div>
        </div>
        
        <div class="px-4 py-3 border-t border-[#212121] bg-[#030303] flex-shrink-0">
            <button id="shuffle-queue-btn" class="w-full bg-[#212121] hover:bg-[#2a2a2a] text-white font-medium py-2.5 rounded-lg transition flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg>
                <span>Shuffle Queue</span>
            </button>
        </div>
    </div>

    <script>
        // CHUNK 1: Configuration & State
        // Multiple API endpoints for load balancing
        const SEARCH_APIS = [
            'https://raspy-sound-0966.arnoy799.workers.dev/',
            // Add more search API endpoints here as you create them:
            // 'https://your-second-worker.username2.workers.dev/',
            // 'https://your-third-worker.username3.workers.dev/',
        ];
        
        const RADIO_APIS = [
            'https://long-pond-4887.arnoy799.workers.dev/',
            'https://jolly-hall-c603.arnoy799.workers.dev/',
            // Add more radio API endpoints here:
            // 'https://your-second-radio-worker.username2.workers.dev/',
            // 'https://your-third-radio-worker.username3.workers.dev/',
        ];
        
        // Helper function to get random API endpoint
        function getRandomAPI(apiArray) {
            return apiArray[Math.floor(Math.random() * apiArray.length)];
        }
        
        const STORAGE_KEYS = { HISTORY: 'music_history', FAVORITES: 'music_favorites', FEED_CACHE: 'music_feed_cache', VIEW_MODE: 'music_view_mode' };
        
        let player, isPlayerReady = false, isPlaying = false, currentQueue = [], currentIndex = -1;
        let updateInterval, isVideoVisible = false, currentView = 'home', lastResults = [], pendingPlayIndex = -1;
        let viewMode = 'grid'; // 'grid' or 'list'
        
        const SVG_PLAY = '<path d="M8 5v14l11-7z"/>';
        const SVG_PAUSE = '<path d="M6 19h4V5H6zm8-14v14h4V5z"/>';

        // CHUNK 2: LocalStorage Manager
        const StorageManager = {
            get(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (e) { return null; }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) { return false; }
            },
            
            // Helper to get YouTube thumbnail URL from videoId
            getThumbnailUrl(videoId, quality = 'medium') {
                if (!videoId) return '';
                // YouTube thumbnail patterns:
                // mqdefault.jpg = medium quality (320x180)
                // hqdefault.jpg = high quality (480x360)
                // sddefault.jpg = standard quality (640x480)
                // maxresdefault.jpg = max quality (1280x720) - not always available
                const qualityMap = {
                    low: 'default',
                    medium: 'mqdefault',
                    high: 'hqdefault',
                    max: 'sddefault'
                };
                return `https://i.ytimg.com/vi/${videoId}/${qualityMap[quality] || 'mqdefault'}.jpg`;
            },
            
            getHistory() {
                return this.get(STORAGE_KEYS.HISTORY) || { searches: [], plays: [], queue_history: [] };
            },
            saveHistory(history) {
                this.set(STORAGE_KEYS.HISTORY, history);
            },
            getFavorites() {
                return this.get(STORAGE_KEYS.FAVORITES) || [];
            },
            saveFavorites(favorites) {
                this.set(STORAGE_KEYS.FAVORITES, favorites);
            },
            addSearch(query) {
                const history = this.getHistory();
                const existing = history.searches.find(s => s.query.toLowerCase() === query.toLowerCase());
                if (existing) {
                    existing.count++;
                    existing.timestamp = Date.now();
                } else {
                    history.searches.push({ query, timestamp: Date.now(), count: 1 });
                }
                history.searches = history.searches.slice(-50);
                this.saveHistory(history);
            },
            addPlay(video) {
                const history = this.getHistory();
                const existing = history.plays.find(p => p.videoId === video.videoId);
                if (existing) {
                    existing.playCount++;
                    existing.lastPlayed = Date.now();
                } else {
                    history.plays.push({
                        videoId: video.videoId,
                        title: video.title,
                        channel: video.channel,
                        // DON'T store thumbnail - generate from videoId
                        playCount: 1,
                        lastPlayed: Date.now(),
                        totalDuration: 0
                    });
                }
                history.plays = history.plays.slice(-100);
                this.saveHistory(history);
            },
            addToQueue(video, source = 'search') {
                const history = this.getHistory();
                history.queue_history.push({
                    videoId: video.videoId,
                    title: video.title,
                    channel: video.channel,
                    // DON'T store thumbnail - generate from videoId
                    addedAt: Date.now(),
                    playedFrom: source
                });
                history.queue_history = history.queue_history.slice(-200);
                this.saveHistory(history);
            },
            toggleFavorite(video) {
                let favorites = this.getFavorites();
                const index = favorites.findIndex(f => f.videoId === video.videoId);
                if (index > -1) {
                    favorites.splice(index, 1);
                } else {
                    favorites.push({
                        videoId: video.videoId,
                        title: video.title,
                        channel: video.channel,
                        // DON'T store thumbnail - generate from videoId
                        addedAt: Date.now()
                    });
                }
                this.saveFavorites(favorites);
                return index === -1;
            },
            isFavorite(videoId) {
                return this.getFavorites().some(f => f.videoId === videoId);
            },
            getViewMode() {
                return this.get(STORAGE_KEYS.VIEW_MODE) || 'grid';
            },
            setViewMode(mode) {
                this.set(STORAGE_KEYS.VIEW_MODE, mode);
            }
        };

        // CHUNK 3: Feed Generation Algorithm
        const FeedGenerator = {
            generate() {
                const history = StorageManager.getHistory();
                const favorites = StorageManager.getFavorites();
                
                // Collect all unique videos from multiple sources
                const allVideos = new Map();
                
                // 1. Add played songs (with play history)
                history.plays.forEach(play => {
                    allVideos.set(play.videoId, {
                        ...play,
                        thumbnail: StorageManager.getThumbnailUrl(play.videoId), // Generate thumbnail
                        source: 'played',
                        score: 0
                    });
                });
                
                // 2. Add favorites (high priority)
                favorites.forEach(fav => {
                    if (!allVideos.has(fav.videoId)) {
                        allVideos.set(fav.videoId, {
                            ...fav,
                            thumbnail: StorageManager.getThumbnailUrl(fav.videoId), // Generate thumbnail
                            playCount: 0,
                            lastPlayed: fav.addedAt,
                            source: 'favorite',
                            score: 0
                        });
                    } else {
                        allVideos.get(fav.videoId).source = 'favorite';
                    }
                });
                
                // 3. Add queue history (DISCOVERY SOURCE - unplayed songs from radio)
                history.queue_history.forEach(queueItem => {
                    // Skip if already in collection or missing critical data
                    if (allVideos.has(queueItem.videoId)) return;
                    if (!queueItem.title || queueItem.title === 'Unknown' || queueItem.title === 'Unknown Title') return;
                    
                    // This is an unplayed song from queue/radio with complete data
                    allVideos.set(queueItem.videoId, {
                        videoId: queueItem.videoId,
                        title: queueItem.title,
                        channel: queueItem.channel || 'Unknown Artist',
                        thumbnail: StorageManager.getThumbnailUrl(queueItem.videoId), // Generate thumbnail
                        playCount: 0,
                        lastPlayed: queueItem.addedAt,
                        addedAt: queueItem.addedAt,
                        source: queueItem.playedFrom || 'radio',
                        score: 0
                    });
                });
                
                if (allVideos.size === 0) {
                    return [];
                }

                // Score all videos with improved algorithm
                const scored = this.scoreVideos(allVideos, history, favorites);
                
                // Diversify and balance content
                const diversified = this.diversify(scored);
                
                return diversified.slice(0, 50); // Increased from 30 to 50
            },
            
            scoreVideos(allVideos, history, favorites) {
                const now = Date.now();
                const maxPlayCount = Math.max(...Array.from(allVideos.values()).map(v => v.playCount || 0), 1);
                
                // Calculate channel engagement scores
                const channelEngagement = this.calculateChannelEngagement(history, favorites);
                
                allVideos.forEach((video, videoId) => {
                    const isFav = favorites.some(f => f.videoId === videoId);
                    const playCount = video.playCount || 0;
                    const lastInteraction = video.lastPlayed || video.addedAt || now;
                    const daysSince = (now - lastInteraction) / (1000 * 60 * 60 * 24);
                    
                    // SCORING COMPONENTS
                    
                    // 1. Frequency Score (0-1) - how often you played it
                    const frequencyScore = playCount > 0 ? (playCount / maxPlayCount) : 0;
                    
                    // 2. Recency Score (0-1) - exponential decay over time
                    const recencyScore = Math.exp(-daysSince / 7); // 7 day half-life
                    
                    // 3. Favorite Bonus (1.5x multiplier)
                    const favoriteBonus = isFav ? 1.5 : 1.0;
                    
                    // 4. Discovery Bonus - boost unplayed content from queue/radio
                    let discoveryBonus = 0;
                    if (playCount === 0 && (video.source === 'radio' || video.source === 'search')) {
                        discoveryBonus = 0.4; // High boost for unplayed discovery content
                    }
                    
                    // 5. Channel Affinity - boost songs from channels you engage with
                    const channelScore = (channelEngagement[video.channel] || 0) * 0.3;
                    
                    // 6. Freshness Penalty - reduce score for very old content
                    let freshnessPenalty = 0;
                    if (daysSince > 30) {
                        freshnessPenalty = Math.min((daysSince - 30) / 60, 0.3); // Max 0.3 penalty
                    }
                    
                    // FINAL SCORE CALCULATION
                    // Balance between familiarity and discovery
                    const baseScore = (frequencyScore * 0.25) + // Reduced weight for played songs
                                     (recencyScore * 0.25) +     // Recent interactions
                                     discoveryBonus +            // Boost unplayed content
                                     channelScore;               // Channel affinity
                    
                    video.score = (baseScore * favoriteBonus) - freshnessPenalty;
                    
                    // Add small random factor for variety (5% variance)
                    video.score += (Math.random() - 0.5) * 0.05;
                });
                
                return Array.from(allVideos.values()).sort((a, b) => b.score - a.score);
            },
            
            calculateChannelEngagement(history, favorites) {
                const engagement = {};
                
                // Track plays per channel
                history.plays.forEach(play => {
                    engagement[play.channel] = (engagement[play.channel] || 0) + play.playCount;
                });
                
                // Boost for favorited channels
                favorites.forEach(fav => {
                    engagement[fav.channel] = (engagement[fav.channel] || 0) + 2;
                });
                
                // Normalize to 0-1 scale
                const maxEngagement = Math.max(...Object.values(engagement), 1);
                Object.keys(engagement).forEach(channel => {
                    engagement[channel] = engagement[channel] / maxEngagement;
                });
                
                return engagement;
            },
            
            diversify(videos) {
                if (videos.length === 0) return [];
                
                const result = [];
                const channelCount = {};
                const sourceCount = { played: 0, radio: 0, search: 0, favorite: 0 };
                let lastChannel = null;
                
                const remaining = [...videos];
                
                while (remaining.length > 0 && result.length < 50) {
                    let bestIndex = -1;
                    let bestScore = -Infinity;
                    
                    // Find best video that maintains diversity
                    for (let i = 0; i < Math.min(remaining.length, 20); i++) { // Check top 20 candidates
                        const video = remaining[i];
                        const channel = video.channel;
                        const source = video.source;
                        
                        let diversityScore = video.score;
                        
                        // Penalize consecutive songs from same channel
                        if (channel === lastChannel) {
                            diversityScore -= 0.5;
                        }
                        
                        // Penalize over-represented channels
                        const channelRep = channelCount[channel] || 0;
                        diversityScore -= channelRep * 0.15;
                        
                        // Balance content sources
                        const sourceRep = sourceCount[source] || 0;
                        const targetRatio = source === 'radio' || source === 'search' ? 0.4 : 0.3; // 40% discovery
                        const sourceRatio = result.length > 0 ? sourceRep / result.length : 0;
                        if (sourceRatio < targetRatio) {
                            diversityScore += 0.2; // Boost underrepresented sources
                        }
                        
                        if (diversityScore > bestScore) {
                            bestScore = diversityScore;
                            bestIndex = i;
                        }
                    }
                    
                    if (bestIndex !== -1) {
                        const selected = remaining.splice(bestIndex, 1)[0];
                        result.push(selected);
                        
                        channelCount[selected.channel] = (channelCount[selected.channel] || 0) + 1;
                        sourceCount[selected.source] = (sourceCount[selected.source] || 0) + 1;
                        lastChannel = selected.channel;
                    } else {
                        // Fallback: just take the first one
                        const selected = remaining.shift();
                        result.push(selected);
                        lastChannel = null;
                    }
                }
                
                return result;
            }
        };

        // CHUNK 4: Helper Functions
        async function fetchWithRetry(url, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                    } else {
                        throw error;
                    }
                }
            }
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s < 10 ? '0'+s : s}`;
        }

        function updateIcons(playing) {
            const path = playing ? SVG_PAUSE : SVG_PLAY;
            document.getElementById('play-icon-desktop').innerHTML = path;
            document.getElementById('play-icon-mobile').innerHTML = path;
        }

        function updateNavButtons() {
            const hasQueue = currentQueue.length > 0;
            ['prev-btn', 'next-btn', 'mobile-prev-btn', 'mobile-next-btn'].forEach(id => {
                const btn = document.getElementById(id);
                btn.disabled = !hasQueue;
                btn.style.opacity = hasQueue ? '1' : '0.3';
            });
        }

        function updateLoveButton() {
            if (currentIndex === -1 || !currentQueue[currentIndex]) return;
            const videoId = currentQueue[currentIndex].videoId;
            const isLoved = StorageManager.isFavorite(videoId);
            
            ['love-btn', 'mobile-love-btn'].forEach(id => {
                const btn = document.getElementById(id);
                if (isLoved) {
                    btn.classList.add('loved');
                } else {
                    btn.classList.remove('loved');
                }
            });
        }

        function updateViewModeButtons() {
            const gridBtn = document.getElementById('view-grid-btn');
            const listBtn = document.getElementById('view-list-btn');
            
            if (!gridBtn || !listBtn) return;
            
            if (viewMode === 'grid') {
                gridBtn.classList.add('bg-white/10', 'text-white');
                gridBtn.classList.remove('text-gray-400');
                listBtn.classList.remove('bg-white/10', 'text-white');
                listBtn.classList.add('text-gray-400');
            } else {
                listBtn.classList.add('bg-white/10', 'text-white');
                listBtn.classList.remove('text-gray-400');
                gridBtn.classList.remove('bg-white/10', 'text-white');
                gridBtn.classList.add('text-gray-400');
            }
        }

        function setViewMode(mode) {
            viewMode = mode;
            StorageManager.setViewMode(mode);
            updateViewModeButtons();
            
            // Re-render current view
            if (currentView === 'home') {
                renderHomeFeed();
            } else if (currentView === 'favorites') {
                renderFavorites();
            } else if (currentView === 'search') {
                renderSearchResults();
            }
        }

        function createViewModeToggle() {
            return `
                <div class="flex bg-[#212121] rounded-lg p-1">
                    <button id="view-grid-btn" class="p-2 rounded-md transition" title="Grid View">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg>
                    </button>
                    <button id="view-list-btn" class="p-2 rounded-md transition" title="List View">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
                    </button>
                </div>
            `;
        }

        function attachViewModeListeners() {
            const gridBtn = document.getElementById('view-grid-btn');
            const listBtn = document.getElementById('view-list-btn');
            
            if (gridBtn) gridBtn.onclick = () => setViewMode('grid');
            if (listBtn) listBtn.onclick = () => setViewMode('list');
            
            updateViewModeButtons();
        }

        // CHUNK 5: YouTube Player Setup
        var tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '100%', width: '100%',
                playerVars: { playsinline: 1, controls: 0, disablekb: 1, fs: 0, iv_load_policy: 3, modestbranding: 1, autoplay: 1, origin: window.location.origin },
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange,
                    onError: onPlayerError
                }
            });
        }

        function onPlayerReady(event) {
            isPlayerReady = true;
            player.setPlaybackQuality('small');
            if (pendingPlayIndex !== -1) {
                loadTrack(pendingPlayIndex);
                pendingPlayIndex = -1;
            }
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                isPlaying = true;
                updateIcons(true);
                startProgressLoop();
            } else if (event.data === YT.PlayerState.PAUSED) {
                isPlaying = false;
                updateIcons(false);
                stopProgressLoop();
            } else if (event.data === YT.PlayerState.ENDED) {
                isPlaying = false;
                updateIcons(false);
                nextTrack();
            }
        }

        function onPlayerError(event) {
            console.error("YT Player Error:", event.data);
            if (event.data === 150 || event.data === 101) {
                console.warn("Video not embeddable, skipping...");
                setTimeout(nextTrack, 1000);
            }
        }

        // CHUNK 6: Playback Control
        function loadTrack(index) {
            if (!currentQueue[index]) return;
            
            if (!isPlayerReady) {
                pendingPlayIndex = index;
                document.getElementById('player-title').innerText = "Loading Player...";
                return;
            }
            
            currentIndex = index;
            const track = currentQueue[index];
            
            document.getElementById('player-title').innerText = track.title;
            document.getElementById('player-artist').innerText = track.channel;
            const thumb = track.thumbnail || (track.thumbnails ? track.thumbnails[0].url : '');
            document.getElementById('player-art').src = thumb || 'https://placehold.co/48x48/333/666?text=Music';
            
            player.loadVideoById(track.videoId);
            
            StorageManager.addPlay(track);
            updateLoveButton();
            renderQueue();
            updateNavButtons();
        }

        function playVideo() { if (isPlayerReady) player.playVideo(); }
        function pauseVideo() { if (isPlayerReady) player.pauseVideo(); }
        function togglePlay() { isPlaying ? pauseVideo() : playVideo(); }

        function nextTrack() {
            if (currentQueue.length > 0) {
                let next = currentIndex + 1;
                if (next >= currentQueue.length) next = 0;
                loadTrack(next);
            }
        }

        function prevTrack() {
            if (currentQueue.length > 0) {
                let prev = currentIndex - 1;
                if (prev < 0) prev = currentQueue.length - 1;
                loadTrack(prev);
            }
        }

        function startProgressLoop() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                if (!player || !player.getCurrentTime) return;
                
                const curr = player.getCurrentTime();
                const total = player.getDuration();
                
                if (total > 0) {
                    const pct = (curr / total) * 100;
                    document.getElementById('desktop-progress-bar').style.width = pct + '%';
                    document.getElementById('desktop-progress-thumb').style.left = pct + '%';
                    document.getElementById('mobile-progress-bar').style.width = pct + '%';
                    
                    document.getElementById('current-time').innerText = formatTime(curr);
                    document.getElementById('total-duration').innerText = formatTime(total);
                }
            }, 500);
        }

        function stopProgressLoop() { clearInterval(updateInterval); }

        function seekTo(e, container) {
            if (!isPlayerReady || player.getDuration() === 0) return;
            const rect = container.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const pct = x / rect.width;
            const time = player.getDuration() * pct;
            player.seekTo(time, true);
        }

        // CHUNK 7: UI Rendering
        async function playSearchItem(video) {
            currentQueue = [video];
            loadTrack(0);
            
            // Ensure we have complete metadata before storing
            const videoWithMetadata = {
                videoId: video.videoId,
                title: video.title || 'Unknown Title',
                channel: video.channel || 'Unknown Artist',
                thumbnail: video.thumbnail || (video.thumbnails && video.thumbnails.length > 0 ? video.thumbnails[0].url : ''),
                duration: video.duration || ''
            };
            
            StorageManager.addToQueue(videoWithMetadata, 'search');

            try {
                // Pick random radio API endpoint
                const radioAPI = getRandomAPI(RADIO_APIS);
                console.log(`Using radio API: ${radioAPI}`);
                
                const res = await fetchWithRetry(`${radioAPI}?videoId=${video.videoId}`);
                if (res.videos && res.videos.length > 0) {
                    currentQueue = res.videos;
                    renderQueue();
                    
                    // Store each radio video with complete metadata
                    res.videos.forEach(v => {
                        const completeVideo = {
                            videoId: v.videoId,
                            title: v.title || 'Unknown Title',
                            channel: v.channel || 'Unknown Artist',
                            thumbnail: v.thumbnail || (v.thumbnails && v.thumbnails.length > 0 ? v.thumbnails[0].url : ''),
                            duration: v.duration || ''
                        };
                        StorageManager.addToQueue(completeVideo, 'radio');
                    });
                }
            } catch (e) {
                console.warn("Radio fetch failed, playing single track. Error:", e.message);
            }
        }

        async function performSearch(query) {
            if (!query) return;
            showLoader(true);
            document.getElementById('content-section').innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Searching "${query}"...</h2>
                </div>
                <div id="results-grid"></div>
            `;

            try {
                // Pick random search API endpoint
                const searchAPI = getRandomAPI(SEARCH_APIS);
                console.log(`Using search API: ${searchAPI}`);
                
                const res = await fetchWithRetry(`${searchAPI}?q=${encodeURIComponent(query)}`);
                lastResults = res.results || [];
                StorageManager.addSearch(query);
                
                document.getElementById('content-section').innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold">Results for "${query}"</h2>
                        ${createViewModeToggle()}
                    </div>
                    <div id="results-grid"></div>
                `;
                
                renderSearchResults();
                attachViewModeListeners();
            } catch (e) {
                document.getElementById('content-section').innerHTML = `
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-red-500">Error fetching results</h2>
                    </div>
                    <div class="text-gray-400 text-center py-10">
                        <p class="mb-2">Failed to load search results. This could be due to:</p>
                        <p class="text-sm">• API rate limits</p>
                        <p class="text-sm">• Network issues</p>
                        <p class="text-sm mb-4">• Worker endpoint problems</p>
                        <button onclick="performSearch('${query}')" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg font-medium transition">
                            Retry Search
                        </button>
                    </div>
                `;
                console.error('Search error:', e);
            } finally {
                showLoader(false);
            }
        }

        function renderSearchResults() {
            const grid = document.getElementById('results-grid');
            if (!grid) return;
            
            grid.innerHTML = '';

            if (lastResults.length === 0) {
                grid.innerHTML = '<p class="text-gray-500 col-span-full text-center py-10">No results found.</p>';
                return;
            }

            if (viewMode === 'grid') {
                grid.className = "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4";
                
                lastResults.forEach(vid => {
                    const isPlayable = vid.duration && !vid.duration.includes('m') && !vid.duration.includes('h');
                    if (!isPlayable) return;

                    const div = document.createElement('div');
                    div.className = "group cursor-pointer p-3 rounded-xl hover:bg-[#1a1a1a] transition card-hover";
                    div.onclick = () => playSearchItem(vid);
                    
                    const thumb = vid.thumbnail || (vid.thumbnails ? vid.thumbnails[0].url : 'https://placehold.co/150');

                    div.innerHTML = `
                        <div class="aspect-square bg-[#1c1c1c] rounded-lg mb-3 relative overflow-hidden">
                            <img src="${thumb}" class="w-full h-full object-cover" loading="lazy">
                            <div class="absolute bottom-2 right-2 bg-black/80 px-2 py-0.5 rounded text-xs font-medium">${vid.duration}</div>
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center transition-all">
                                <div class="bg-white/90 rounded-full p-3">
                                    <svg class="w-8 h-8 text-black pl-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                        </div>
                        <h4 class="font-semibold text-sm truncate text-white mb-1">${vid.title}</h4>
                        <p class="text-xs text-gray-400 truncate">${vid.channel}</p>
                    `;
                    grid.appendChild(div);
                });
            } else {
                grid.className = "space-y-2";
                
                lastResults.forEach(vid => {
                    const isPlayable = vid.duration && !vid.duration.includes('m') && !vid.duration.includes('h');
                    if (!isPlayable) return;

                    const div = document.createElement('div');
                    div.className = "flex items-center space-x-4 p-3 rounded-xl hover:bg-[#1a1a1a] cursor-pointer transition group";
                    div.onclick = () => playSearchItem(vid);
                    
                    const thumb = vid.thumbnail || (vid.thumbnails ? vid.thumbnails[0].url : 'https://placehold.co/150');

                    div.innerHTML = `
                        <div class="relative flex-shrink-0">
                            <img src="${thumb}" class="w-20 h-20 sm:w-24 sm:h-24 rounded-lg object-cover" loading="lazy">
                            <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center rounded-lg transition-all">
                                <div class="bg-white/90 rounded-full p-2">
                                    <svg class="w-6 h-6 text-black pl-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-base truncate text-white mb-1">${vid.title}</h4>
                            <p class="text-sm text-gray-400 truncate">${vid.channel}</p>
                        </div>
                        <div class="text-xs text-gray-500 font-medium hidden sm:block">${vid.duration}</div>
                    `;
                    grid.appendChild(div);
                });
            }
        }

        function renderHomeFeed() {
            const section = document.getElementById('content-section');
            const feed = FeedGenerator.generate();
            
            if (feed.length === 0) {
                section.innerHTML = `
                    <div class="empty-state">
                        <svg class="w-24 h-24 text-gray-600 mb-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                        </svg>
                        <h2 class="text-3xl font-bold mb-3">Welcome to Music</h2>
                        <p class="text-gray-400 text-lg mb-2">Start your journey by searching for songs</p>
                        <p class="text-gray-500 text-sm">Play music to help us build a personalized feed just for you</p>
                    </div>
                `;
                return;
            }

            section.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">For You</h2>
                        <p class="text-sm text-gray-400 mt-1">${feed.length} personalized songs</p>
                    </div>
                    ${createViewModeToggle()}
                </div>
                <div id="feed-grid"></div>
            `;

            attachViewModeListeners();
            renderFeedGrid(feed);
        }

        function renderFeedGrid(feed) {
            const grid = document.getElementById('feed-grid');
            if (!grid) return;
            
            grid.innerHTML = '';

            if (viewMode === 'grid') {
                grid.className = "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4";
                
                feed.forEach(vid => {
                    // Validate video has required data
                    if (!vid.videoId || !vid.title || vid.title === 'Unknown') return;
                    
                    const div = document.createElement('div');
                    div.className = "group cursor-pointer p-3 rounded-xl hover:bg-[#1a1a1a] transition card-hover";
                    div.onclick = () => playSearchItem(vid);

                    const thumbnail = vid.thumbnail || 'https://placehold.co/300x300/1c1c1c/666?text=No+Image';

                    div.innerHTML = `
                        <div class="aspect-square bg-[#1c1c1c] rounded-lg mb-3 relative overflow-hidden">
                            <img src="${thumbnail}" class="w-full h-full object-cover" loading="lazy" onerror="this.src='https://placehold.co/300x300/1c1c1c/666?text=No+Image'">
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center transition-all">
                                <div class="bg-white/90 rounded-full p-3">
                                    <svg class="w-8 h-8 text-black pl-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                        </div>
                        <h4 class="font-semibold text-sm truncate text-white mb-1">${vid.title}</h4>
                        <p class="text-xs text-gray-400 truncate">${vid.channel || 'Unknown Artist'}</p>
                    `;
                    grid.appendChild(div);
                });
            } else {
                grid.className = "space-y-2";
                
                feed.forEach(vid => {
                    // Validate video has required data
                    if (!vid.videoId || !vid.title || vid.title === 'Unknown') return;
                    
                    const div = document.createElement('div');
                    div.className = "flex items-center space-x-4 p-3 rounded-xl hover:bg-[#1a1a1a] cursor-pointer transition group";
                    div.onclick = () => playSearchItem(vid);

                    const thumbnail = vid.thumbnail || 'https://placehold.co/300x300/1c1c1c/666?text=No+Image';

                    div.innerHTML = `
                        <div class="relative flex-shrink-0">
                            <img src="${thumbnail}" class="w-20 h-20 sm:w-24 sm:h-24 rounded-lg object-cover" loading="lazy" onerror="this.src='https://placehold.co/300x300/1c1c1c/666?text=No+Image'">
                            <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center rounded-lg transition-all">
                                <div class="bg-white/90 rounded-full p-2">
                                    <svg class="w-6 h-6 text-black pl-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-base truncate text-white mb-1">${vid.title}</h4>
                            <p class="text-sm text-gray-400 truncate">${vid.channel || 'Unknown Artist'}</p>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            }
        }

        function renderExploreFeed() {
            const section = document.getElementById('content-section');
            section.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold">Explore</h2>
                </div>
                <div class="space-y-4">
                    <div class="bg-gradient-to-r from-purple-500/20 to-pink-500/20 rounded-xl p-6 border border-purple-500/30">
                        <h3 class="text-xl font-bold mb-2">Try searching for music</h3>
                        <p class="text-gray-400 text-sm">Use the search bar above to discover new songs and artists</p>
                    </div>
                </div>
            `;
        }

        function renderFavorites() {
            const section = document.getElementById('content-section');
            const favorites = StorageManager.getFavorites();
            
            if (favorites.length === 0) {
                section.innerHTML = `
                    <div class="empty-state">
                        <svg class="w-24 h-24 text-gray-600 mb-6" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                        <h2 class="text-3xl font-bold mb-3">No Favorites Yet</h2>
                        <p class="text-gray-400 text-lg">Tap the heart icon on songs you love to save them here</p>
                    </div>
                `;
                return;
            }

            section.innerHTML = `
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Favorites</h2>
                        <p class="text-sm text-gray-400 mt-1">${favorites.length} loved songs</p>
                    </div>
                    ${createViewModeToggle()}
                </div>
                <div id="favorites-grid"></div>
            `;

            attachViewModeListeners();
            renderFavoritesGrid(favorites);
        }

        function renderFavoritesGrid(favorites) {
            const grid = document.getElementById('favorites-grid');
            if (!grid) return;
            
            grid.innerHTML = '';

            if (viewMode === 'grid') {
                grid.className = "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4";
                
                favorites.reverse().forEach(vid => {
                    const div = document.createElement('div');
                    div.className = "group cursor-pointer p-3 rounded-xl hover:bg-[#1a1a1a] transition card-hover relative";
                    div.onclick = () => playSearchItem(vid);
                    
                    div.innerHTML = `
                        <div class="aspect-square bg-[#1c1c1c] rounded-lg mb-3 relative overflow-hidden">
                            <img src="${vid.thumbnail}" class="w-full h-full object-cover" loading="lazy">
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center transition-all">
                                <div class="bg-white/90 rounded-full p-3">
                                    <svg class="w-8 h-8 text-black pl-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                        </div>
                        <h4 class="font-semibold text-sm truncate text-white mb-1">${vid.title}</h4>
                        <p class="text-xs text-gray-400 truncate">${vid.channel}</p>
                    `;
                    grid.appendChild(div);
                });
            } else {
                grid.className = "space-y-2";
                
                favorites.reverse().forEach(vid => {
                    const div = document.createElement('div');
                    div.className = "flex items-center space-x-4 p-3 rounded-xl hover:bg-[#1a1a1a] cursor-pointer transition group";
                    div.onclick = () => playSearchItem(vid);
                    
                    div.innerHTML = `
                        <div class="relative flex-shrink-0">
                            <img src="${vid.thumbnail}" class="w-20 h-20 sm:w-24 sm:h-24 rounded-lg object-cover" loading="lazy">
                            <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center rounded-lg transition-all">
                                <div class="bg-white/90 rounded-full p-2">
                                    <svg class="w-6 h-6 text-black pl-0.5" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-base truncate text-white mb-1">${vid.title}</h4>
                            <p class="text-sm text-gray-400 truncate">${vid.channel}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-red-500" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </div>
                    `;
                    grid.appendChild(div);
                });
            }
        }

        function renderQueue() {
            const list = document.getElementById('queue-list');
            const countEl = document.getElementById('queue-count');
            
            list.innerHTML = '';
            
            if (currentQueue.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-16 px-4">
                        <svg class="w-16 h-16 text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                        </svg>
                        <p class="text-gray-400 text-center">Your queue is empty</p>
                        <p class="text-gray-500 text-sm text-center mt-1">Play a song to get started</p>
                    </div>
                `;
                countEl.textContent = '0 songs in queue';
                return;
            }
            
            countEl.textContent = `${currentQueue.length} song${currentQueue.length !== 1 ? 's' : ''} in queue`;
            
            currentQueue.forEach((vid, i) => {
                const el = document.createElement('div');
                const isActive = i === currentIndex;
                el.className = `queue-item group flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition-all ${isActive ? 'active text-white bg-[#212121]' : 'text-gray-300 hover:bg-[#1a1a1a]'}`;
                
                const playHandler = () => loadTrack(i);
                const removeHandler = (e) => {
                    e.stopPropagation();
                    removeFromQueue(i);
                };
                
                let tUrl = vid.thumbnail || (vid.thumbnails && vid.thumbnails.length > 0 ? vid.thumbnails[0].url : 'https://placehold.co/40');

                el.innerHTML = `
                    <div class="flex items-center justify-center w-6 flex-shrink-0">
                        ${isActive 
                            ? '<div class="w-4 h-4 flex items-center justify-center"><div class="w-1 h-4 bg-red-500 mx-0.5 animate-pulse"></div><div class="w-1 h-3 bg-red-500 mx-0.5 animate-pulse" style="animation-delay: 0.2s"></div><div class="w-1 h-4 bg-red-500 mx-0.5 animate-pulse" style="animation-delay: 0.4s"></div></div>'
                            : `<span class="text-xs font-bold text-gray-500">${i+1}</span>`
                        }
                    </div>
                    <img src="${tUrl}" class="w-12 h-12 rounded-md bg-[#333] object-cover flex-shrink-0" loading="lazy">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold truncate">${vid.title}</p>
                        <p class="text-xs text-gray-400 truncate mt-0.5">${vid.channel}</p>
                    </div>
                    <button class="remove-queue-btn opacity-0 group-hover:opacity-100 transition-opacity p-2 hover:bg-red-500/20 rounded-full" title="Remove from queue">
                        <svg class="w-4 h-4 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                `;
                
                el.onclick = playHandler;
                el.querySelector('.remove-queue-btn').onclick = removeHandler;
                
                list.appendChild(el);
            });
        }

        function removeFromQueue(index) {
            if (index === currentIndex) {
                nextTrack();
            } else if (index < currentIndex) {
                currentIndex--;
            }
            currentQueue.splice(index, 1);
            renderQueue();
            updateNavButtons();
        }

        function clearQueue() {
            if (currentQueue.length === 0) return;
            
            if (confirm('Clear entire queue? This will stop playback.')) {
                currentQueue = [];
                currentIndex = -1;
                isPlaying = false;
                updateIcons(false);
                stopProgressLoop();
                
                document.getElementById('player-title').innerText = 'Ready to play';
                document.getElementById('player-artist').innerText = 'Select a song';
                document.getElementById('player-art').src = 'https://placehold.co/48x48/333/666?text=Music';
                
                renderQueue();
                updateNavButtons();
            }
        }

        function shuffleQueue() {
            if (currentQueue.length <= 1) return;
            
            const currentTrack = currentQueue[currentIndex];
            const remaining = currentQueue.filter((_, i) => i !== currentIndex);
            
            for (let i = remaining.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
            }
            
            currentQueue = [currentTrack, ...remaining];
            currentIndex = 0;
            renderQueue();
        }

        function showLoader(show) {
            // Can add a loader element if needed
        }

        // CHUNK 8: Navigation & View Management
        function switchView(view) {
            currentView = view;
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            if (view === 'home') {
                document.getElementById('nav-home').classList.add('active');
                renderHomeFeed();
            } else if (view === 'explore') {
                document.getElementById('nav-explore').classList.add('active');
                renderExploreFeed();
            } else if (view === 'favorites') {
                document.getElementById('nav-favorites').classList.add('active');
                renderFavorites();
            }
        }

        // CHUNK 9: Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved view mode
            viewMode = StorageManager.getViewMode();
            
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && searchInput.value.trim()) {
                    currentView = 'search';
                    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                    performSearch(searchInput.value.trim());
                }
            });

            // Sidebar Toggle
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const menuBtn = document.getElementById('menu-btn');
            const closeSidebarBtn = document.getElementById('close-sidebar-btn');
            
            const openSidebar = () => {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            };
            
            const closeSidebar = () => {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
                document.body.style.overflow = '';
            };
            
            menuBtn.onclick = () => {
                if (window.innerWidth < 640) {
                    openSidebar();
                } else {
                    sidebar.classList.toggle('-translate-x-full');
                }
            };
            
            closeSidebarBtn.onclick = closeSidebar;
            sidebarOverlay.onclick = closeSidebar;
            
            // Close sidebar on navigation (mobile)
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    if (window.innerWidth < 640) {
                        closeSidebar();
                    }
                });
            });

            document.getElementById('play-pause-btn').onclick = togglePlay;
            document.getElementById('mobile-play-btn').onclick = togglePlay;
            document.getElementById('next-btn').onclick = nextTrack;
            document.getElementById('prev-btn').onclick = prevTrack;
            document.getElementById('mobile-next-btn').onclick = nextTrack;
            document.getElementById('mobile-prev-btn').onclick = prevTrack;

            document.getElementById('desktop-progress-container').onclick = (e) => seekTo(e, document.getElementById('desktop-progress-container'));
            document.getElementById('mobile-progress-container').onclick = (e) => seekTo(e, document.getElementById('mobile-progress-container'));

            // Queue Panel
            document.getElementById('queue-btn').onclick = () => document.getElementById('queue-panel').classList.remove('translate-x-full');
            document.getElementById('close-queue-btn').onclick = () => document.getElementById('queue-panel').classList.add('translate-x-full');
            document.getElementById('clear-queue-btn').onclick = clearQueue;
            document.getElementById('shuffle-queue-btn').onclick = shuffleQueue;

            const toggleVideoUI = () => {
                isVideoVisible = !isVideoVisible;
                const wrapper = document.getElementById('video-wrapper');
                const btn = document.getElementById('toggle-video-btn');
                if (isVideoVisible) {
                    wrapper.classList.remove('video-hidden');
                    wrapper.classList.add('video-visible');
                    btn.classList.add('text-red-500', 'border-red-500');
                } else {
                    wrapper.classList.add('video-hidden');
                    wrapper.classList.remove('video-visible');
                    btn.classList.remove('text-red-500', 'border-red-500');
                }
            };
            document.getElementById('toggle-video-btn').onclick = toggleVideoUI;
            document.getElementById('hide-video-btn').onclick = toggleVideoUI;

            const toggleLove = () => {
                if (currentIndex === -1 || !currentQueue[currentIndex]) return;
                const video = currentQueue[currentIndex];
                const isNowLoved = StorageManager.toggleFavorite(video);
                updateLoveButton();
                
                const btn = document.getElementById('love-btn');
                btn.classList.add('heart-animate');
                setTimeout(() => btn.classList.remove('heart-animate'), 300);
                
                if (currentView === 'favorites') {
                    renderFavorites();
                }
                if (currentView === 'home') {
                    renderHomeFeed();
                }
            };
            document.getElementById('love-btn').onclick = toggleLove;
            document.getElementById('mobile-love-btn').onclick = toggleLove;

            document.getElementById('nav-home').onclick = (e) => {
                e.preventDefault();
                switchView('home');
            };
            document.getElementById('nav-explore').onclick = (e) => {
                e.preventDefault();
                switchView('explore');
            };
            document.getElementById('nav-favorites').onclick = (e) => {
                e.preventDefault();
                switchView('favorites');
            };

            switchView('home');
        });
    </script>
</body>
</html>

