<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YtMusic</title>
    <link rel="icon" type="image/png" href="https://img.icons8.com/?size=100&id=YNioBT5SxQw3&format=png&color=000000">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #404040; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .queue-item.active { background-color: #212121; border-left: 3px solid #ef4444; padding-left: 5px; }
        
        .video-hidden { opacity: 0; pointer-events: none; z-index: -10; }
        .video-visible { opacity: 1; pointer-events: auto; z-index: 50; }
        
        .video-wrapper-full {
            top: 50% !important; left: 50% !important; transform: translate(-50%, -50%) !important;
            width: 100% !important; max-width: 1000px !important; height: auto !important;
            aspect-ratio: 16/9 !important; border: none !important; box-shadow: none !important;
            bottom: auto !important; right: auto !important; z-index: 60 !important;
        }

        .heart-btn { transition: all 0.2s ease; }
        .heart-btn.loved { color: #ef4444; }
        @keyframes heartbeat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
        .heart-animate { animation: heartbeat 0.3s ease; }
        
        .nav-item { transition: all 0.2s ease; }
        .nav-item.active { background: #212121; color: white; font-weight: 600; }
        
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-4px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3); }

        .sidebar-collapsed { width: 4.5rem !important; }
        .sidebar-collapsed .nav-text { display: none; }
        .sidebar-collapsed .nav-item { justify-content: center; padding-left: 0; padding-right: 0; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #ef4444;
            cursor: pointer; margin-top: -6px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #404040; border-radius: 2px;
        }
        
        /* Skeleton Animation */
        .skeleton {
            background: linear-gradient(90deg, #222 25%, #2a2a2a 50%, #222 75%);
            background-size: 200% 100%; animation: loading 1.5s infinite;
        }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="bg-[#0f0f0f] text-white h-screen flex flex-col">
    
    <!-- Video Player Wrapper -->
    <div id="video-wrapper" class="fixed bottom-24 right-4 shadow-2xl rounded-lg overflow-hidden w-64 aspect-video bg-black border border-[#333] video-hidden transition-all duration-300">
        <div id="yt-player"></div>
        <button id="hide-video-btn" class="absolute top-2 right-2 bg-black/50 hover:bg-black/80 text-white p-1 rounded-full z-10">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center">
        <div class="bg-[#212121] p-6 rounded-xl w-80 sm:w-96 shadow-2xl border border-[#333]">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold">Settings</h3>
                <button id="close-settings-btn" class="text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between text-sm mb-2">
                        <span class="text-gray-300">Mini Player Size</span>
                        <span id="size-value" class="text-gray-400">Medium</span>
                    </div>
                    <input type="range" id="player-size-slider" min="200" max="600" value="320" class="w-full">
                </div>
                <div class="pt-4 border-t border-[#333]">
                    <p class="text-xs text-gray-500 text-center">YtMusic Clone v1.3</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Full Player Overlay -->
    <div id="full-player-overlay" class="fixed inset-0 bg-[#030303] z-50 transform translate-y-full transition-transform duration-300 flex flex-col">
        <div class="flex items-center justify-between p-6">
            <button id="close-full-player-btn" class="text-white hover:bg-white/10 p-2 rounded-full">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div class="flex bg-[#212121] rounded-lg p-1">
                <button id="fp-mode-art" class="px-4 py-1.5 rounded-md text-sm font-medium bg-white/10 text-white">Art</button>
                <button id="fp-mode-video" class="px-4 py-1.5 rounded-md text-sm font-medium text-gray-400 hover:text-white">Video</button>
            </div>
            <button id="fp-settings-btn" class="text-white hover:bg-white/10 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            </button>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center p-8 relative">
            <div id="fp-art-container" class="w-full max-w-md aspect-square shadow-2xl rounded-xl overflow-hidden relative">
                <img id="fp-art-img" src="" class="w-full h-full object-cover">
            </div>
            <div id="fp-video-placeholder" class="absolute inset-0 pointer-events-none"></div>
            <div class="mt-8 text-center max-w-2xl px-4">
                <h2 id="fp-title" class="text-2xl sm:text-3xl font-bold text-white mb-2 truncate"></h2>
                <p id="fp-artist" class="text-lg sm:text-xl text-gray-400 truncate"></p>
            </div>
        </div>
        <div class="p-6 sm:p-12 pb-16 bg-gradient-to-t from-black/50 to-transparent">
            <div class="flex items-center space-x-3 text-sm text-gray-400 mb-6">
                <span id="fp-current-time">0:00</span>
                <div id="fp-progress-container" class="relative flex-1 h-1.5 bg-gray-600 rounded cursor-pointer group">
                    <div id="fp-progress-bar" class="absolute h-full bg-red-500 rounded w-0"></div>
                </div>
                <span id="fp-total-duration">0:00</span>
            </div>
            <div class="flex items-center justify-center space-x-8 sm:space-x-12">
                <button id="fp-prev-btn" class="text-white hover:text-gray-300"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <button id="fp-play-btn" class="bg-white text-black rounded-full p-4 hover:scale-105 transition transform">
                    <svg id="fp-play-icon" class="w-8 h-8 pl-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                </button>
                <button id="fp-next-btn" class="text-white hover:text-gray-300"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM7 18l8.5-6L7 6z"/></svg></button>
            </div>
            <div class="flex justify-between items-center mt-8 px-4">
                <button id="fp-yt-btn" class="text-gray-400 hover:text-red-500 flex items-center space-x-2 text-sm font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                    <span>Open in YouTube</span>
                </button>
                <button id="fp-love-btn" class="text-gray-400 hover:text-red-500 heart-btn">
                     <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
            </div>
        </div>
    </div>

    <div class="flex flex-1 overflow-hidden pb-16 sm:pb-20">
        <!-- Sidebar Overlay (Mobile) -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-20 hidden"></div>
        
        <aside id="sidebar" class="fixed sm:relative w-60 bg-[#0f0f0f] flex flex-col p-4 border-r border-[#212121] h-full z-30 transform -translate-x-full sm:translate-x-0 transition-all duration-300">
            <div class="flex items-center justify-between mb-8 px-2">
                <div class="flex items-center space-x-2 overflow-hidden whitespace-nowrap">
                    <button id="desktop-sidebar-toggle" class="hidden sm:block text-gray-400 hover:text-white mr-1">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <img src="https://img.icons8.com/?size=100&id=YNioBT5SxQw3&format=png&color=000000" class="w-8 h-8 flex-shrink-0">
                    <span class="text-xl font-bold tracking-tighter nav-text">Music</span>
                </div>
                <button id="close-sidebar-btn" class="sm:hidden text-gray-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <nav class="space-y-1 flex-1">
                <a href="#" id="nav-home" class="nav-item flex items-center space-x-4 p-3 rounded-lg text-gray-400 hover:bg-[#212121] active">
                    <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg><span class="nav-text">Home</span>
                </a>
                <a href="#" id="nav-explore" class="nav-item flex items-center space-x-4 p-3 rounded-lg text-gray-400 hover:bg-[#212121]">
                    <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 10.9c-.61 0-1.1.49-1.1 1.1s.49 1.1 1.1 1.1c.61 0 1.1-.49 1.1-1.1s-.49-1.1-1.1-1.1zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm2.19 12.19L6 18l3.81-8.19L18 6l-3.81 8.19z"/></svg><span class="nav-text">Explore</span>
                </a>
                <a href="#" id="nav-favorites" class="nav-item flex items-center space-x-4 p-3 rounded-lg text-gray-400 hover:bg-[#212121]">
                    <svg class="w-6 h-6 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg><span class="nav-text">Favorites</span>
                </a>
            </nav>
            <div class="border-t border-[#212121] pt-4 mt-2">
                <button id="nav-settings" class="nav-item w-full flex items-center space-x-4 p-3 rounded-lg text-gray-400 hover:bg-[#212121] text-left">
                    <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    <span class="nav-text">Settings</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-[#030303] overflow-hidden relative">
            <div class="absolute inset-0 bg-gradient-to-b from-purple-900/20 via-[#030303] to-[#030303] pointer-events-none z-0"></div>
            <header class="relative z-10 h-16 flex items-center px-4 sticky top-0 bg-[#030303]/95 backdrop-blur border-b border-[#212121]">
                <div class="flex items-center w-full space-x-3">
                    <button id="menu-btn" class="sm:hidden text-white hover:bg-[#212121] p-2 rounded-lg transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <div class="relative flex-1 max-w-2xl">
                        <input type="text" id="search-input" placeholder="Search songs, artists..." class="w-full bg-[#212121] text-white rounded-full py-2.5 pl-11 pr-4 focus:outline-none focus:ring-2 focus:ring-red-500/50 placeholder-gray-500 transition">
                        <svg class="w-5 h-5 text-gray-500 absolute left-4 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                    <div class="w-9 h-9 rounded-full bg-gradient-to-br from-purple-500 to-pink-500 flex items-center justify-center text-sm font-bold flex-shrink-0">U</div>
                </div>
            </header>

            <section class="flex-1 overflow-y-auto custom-scrollbar p-4 sm:p-8 relative z-10" id="content-section"></section>
        </main>
    </div>

    <footer id="player-bar" class="fixed bottom-0 left-0 w-full bg-[#121212]/90 backdrop-blur-xl border-t border-white/5 z-40 h-16 sm:h-20 transition-all duration-300">
        <div class="block sm:hidden mobile-progress-container" id="mobile-progress-container">
            <div id="mobile-progress-bar" class="mobile-progress-bar" style="width: 0%"></div>
        </div>
        <div class="flex items-center justify-between h-full px-2 sm:px-4">
            <div class="flex items-center flex-1 min-w-0 mr-2">
                <button id="mobile-prev-btn" class="sm:hidden text-gray-300 p-2 mr-1"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                <img id="player-art" src="https://placehold.co/48x48/333/666?text=Music" class="w-10 h-10 sm:w-12 sm:h-12 rounded bg-gray-800 object-cover flex-shrink-0 cursor-pointer" title="Expand">
                <div class="ml-3 overflow-hidden flex-1 cursor-pointer" id="player-info-area">
                    <p id="player-title" class="text-sm sm:text-base font-medium truncate text-white">Ready to play</p>
                    <p id="player-artist" class="text-xs sm:text-sm text-gray-400 truncate">Select a song</p>
                </div>
                <button id="love-btn" class="heart-btn hidden sm:block ml-2 text-gray-400 hover:text-red-500 p-2">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
            </div>
            <div class="hidden sm:flex flex-col items-center flex-1 max-w-xl">
                <div class="flex items-center space-x-6 mb-1">
                    <button id="prev-btn" class="text-gray-400 hover:text-white disabled:opacity-30"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg></button>
                    <button id="play-pause-btn" class="bg-white text-black rounded-full p-2 hover:scale-105 transition transform"><svg id="play-icon-desktop" class="w-8 h-8 pl-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                    <button id="next-btn" class="text-gray-400 hover:text-white disabled:opacity-30"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM7 18l8.5-6L7 6z"/></svg></button>
                </div>
                <div class="w-full flex items-center space-x-2 text-xs text-gray-400">
                    <span id="current-time">0:00</span>
                    <div id="desktop-progress-container" class="relative flex-1 h-1 bg-gray-600 rounded cursor-pointer group">
                        <div id="desktop-progress-bar" class="absolute h-full bg-red-500 rounded w-0"></div>
                        <div class="absolute h-3 w-3 bg-white rounded-full -top-1 opacity-0 group-hover:opacity-100 transition-opacity" style="left: 0%" id="desktop-progress-thumb"></div>
                    </div>
                    <span id="total-duration">0:00</span>
                </div>
            </div>
            <div class="flex items-center justify-end space-x-2 sm:space-x-4 flex-1 sm:flex-none">
                <button id="mobile-play-btn" class="sm:hidden p-2 text-white"><svg id="play-icon-mobile" class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg></button>
                <button id="mobile-next-btn" class="sm:hidden p-2 text-gray-300"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM7 18l8.5-6L7 6z"/></svg></button>
                <button id="mobile-love-btn" class="heart-btn sm:hidden text-gray-400 hover:text-red-500">
                    <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
                <a id="open-yt-btn" href="#" target="_blank" class="hidden sm:block text-gray-400 hover:text-white" title="Open in YouTube">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </a>
                <button id="toggle-video-btn" class="text-gray-400 hover:text-red-500 transition" title="Toggle Video">
                    <span class="text-xs font-bold border border-current px-1.5 py-0.5 rounded">VIDEO</span>
                </button>
                <button id="full-player-btn" class="text-gray-400 hover:text-white hidden sm:block" title="Full Player">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                </button>
                <button id="queue-btn" class="text-gray-400 hover:text-white"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg></button>
            </div>
        </div>
    </footer>

    <div id="queue-panel" class="fixed top-0 right-0 h-full w-full sm:w-96 bg-[#030303] border-l border-[#333] z-30 transform translate-x-full transition-transform duration-300 overflow-hidden shadow-2xl flex flex-col">
        <div class="px-4 py-4 flex items-center justify-between border-b border-[#212121] bg-[#030303] flex-shrink-0">
            <div>
                <h3 class="font-bold text-xl">Up Next</h3>
                <p class="text-xs text-gray-400 mt-0.5" id="queue-count">0 songs in queue</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="clear-queue-btn" class="text-gray-400 hover:text-red-500 text-xs font-medium px-3 py-1.5 rounded-lg hover:bg-[#212121] transition" title="Clear Queue">Clear</button>
                <button id="close-queue-btn" class="text-gray-400 hover:text-white p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto custom-scrollbar">
            <div id="queue-list" class="p-2">
                <p class="text-gray-500 text-center mt-10">Queue is empty</p>
            </div>
        </div>
        <div class="px-4 py-3 border-t border-[#212121] bg-[#030303] flex-shrink-0">
            <button id="shuffle-queue-btn" class="w-full bg-[#212121] hover:bg-[#2a2a2a] text-white font-medium py-2.5 rounded-lg transition flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M10.59 9.17L5.41 4 4 5.41l5.17 5.17 1.42-1.41zM14.5 4l2.04 2.04L4 18.59 5.41 20 17.96 7.46 20 9.5V4h-5.5zm.33 9.41l-1.41 1.41 3.13 3.13L14.5 20H20v-5.5l-2.04 2.04-3.13-3.13z"/></svg><span>Shuffle Queue</span>
            </button>
        </div>
    </div>

    <script>
        const SEARCH_APIS = ['https://raspy-sound-0966.arnoy799.workers.dev/', 'https://wispy-wave-f6c0.arnoy799.workers.dev/'];
        const RADIO_APIS = ['https://long-pond-4887.arnoy799.workers.dev/', 'https://jolly-hall-c603.arnoy799.workers.dev/'];
        function getRandomAPI(apiArray) { return apiArray[Math.floor(Math.random() * apiArray.length)]; }
        
        const STORAGE_KEYS = { HISTORY: 'music_history', FAVORITES: 'music_favorites', VIEW_MODE: 'music_view_mode', SETTINGS: 'music_settings', BLACKLIST: 'music_blacklist' };
        
        let player, isPlayerReady = false, isPlaying = false, currentQueue = [], currentIndex = -1;
        let updateInterval, isVideoVisible = false, currentView = 'home', lastResults = [], pendingPlayIndex = -1;
        let viewMode = 'grid', isFullPlayerOpen = false, fullPlayerMode = 'art'; 
        
        const SVG_PLAY = '<path d="M8 5v14l11-7z"/>';
        const SVG_PAUSE = '<path d="M6 19h4V5H6zm8-14v14h4V5z"/>';

        const StorageManager = {
            get(key) { try { return JSON.parse(localStorage.getItem(key)); } catch (e) { return null; } },
            set(key, value) { try { localStorage.setItem(key, JSON.stringify(value)); return true; } catch (e) { return false; } },
            getThumbnailUrl(videoId) { return `https://i.ytimg.com/vi/${videoId}/mqdefault.jpg`; },
            getHistory() { return this.get(STORAGE_KEYS.HISTORY) || { searches: [], plays: [], queue_history: [] }; },
            saveHistory(history) { this.set(STORAGE_KEYS.HISTORY, history); },
            getFavorites() { return this.get(STORAGE_KEYS.FAVORITES) || []; },
            saveFavorites(favorites) { this.set(STORAGE_KEYS.FAVORITES, favorites); },
            getSettings() { return this.get(STORAGE_KEYS.SETTINGS) || { videoSize: 320, sidebarCollapsed: false }; },
            saveSettings(settings) { this.set(STORAGE_KEYS.SETTINGS, settings); },
            getBlacklist() { return this.get(STORAGE_KEYS.BLACKLIST) || []; },
            addToBlacklist(videoId) {
                const list = this.getBlacklist();
                if (!list.includes(videoId)) {
                    list.push(videoId);
                    this.set(STORAGE_KEYS.BLACKLIST, list);
                }
            },
            addSearch(query) {
                const history = this.getHistory();
                const existing = history.searches.find(s => s.query.toLowerCase() === query.toLowerCase());
                if (existing) { existing.count++; existing.timestamp = Date.now(); } 
                else { history.searches.push({ query, timestamp: Date.now(), count: 1 }); }
                history.searches = history.searches.slice(-50);
                this.saveHistory(history);
            },
            addPlay(video) {
                const history = this.getHistory();
                const existing = history.plays.findIndex(p => p.videoId === video.videoId);
                if (existing > -1) { history.plays.splice(existing, 1); }
                history.plays.unshift({
                    videoId: video.videoId, title: video.title, channel: video.channel,
                    playCount: (history.plays[existing]?.playCount || 0) + 1, lastPlayed: Date.now()
                });
                history.plays = history.plays.slice(-100);
                this.saveHistory(history);
            },
            addToQueue(video, source = 'search') {
                const history = this.getHistory();
                history.queue_history.push({ videoId: video.videoId, title: video.title, channel: video.channel, addedAt: Date.now(), playedFrom: source });
                history.queue_history = history.queue_history.slice(-200);
                this.saveHistory(history);
            },
            toggleFavorite(video) {
                let favorites = this.getFavorites();
                const index = favorites.findIndex(f => f.videoId === video.videoId);
                if (index > -1) favorites.splice(index, 1);
                else favorites.push({ videoId: video.videoId, title: video.title, channel: video.channel, addedAt: Date.now() });
                this.saveFavorites(favorites);
                return index === -1;
            },
            isFavorite(videoId) { return this.getFavorites().some(f => f.videoId === videoId); },
            getViewMode() { return this.get(STORAGE_KEYS.VIEW_MODE) || 'grid'; },
            setViewMode(mode) { this.set(STORAGE_KEYS.VIEW_MODE, mode); }
        };

        const FeedGenerator = {
            generate() {
                const history = StorageManager.getHistory();
                const favorites = StorageManager.getFavorites();
                const blacklist = StorageManager.getBlacklist();
                const allVideos = new Map();

                const filterBlacklist = (v) => !blacklist.includes(v.videoId);

                history.plays.filter(filterBlacklist).forEach(p => allVideos.set(p.videoId, { ...p, thumbnail: StorageManager.getThumbnailUrl(p.videoId), source: 'played', score: 0 }));
                favorites.filter(filterBlacklist).forEach(f => {
                    if (!allVideos.has(f.videoId)) allVideos.set(f.videoId, { ...f, thumbnail: StorageManager.getThumbnailUrl(f.videoId), playCount: 0, lastPlayed: f.addedAt, source: 'favorite', score: 0 });
                    else allVideos.get(f.videoId).source = 'favorite';
                });
                history.queue_history.filter(filterBlacklist).forEach(q => {
                    if (allVideos.has(q.videoId) || !q.title) return;
                    allVideos.set(q.videoId, { ...q, thumbnail: StorageManager.getThumbnailUrl(q.videoId), playCount: 0, lastPlayed: q.addedAt, source: q.playedFrom || 'radio', score: 0 });
                });
                if (allVideos.size === 0) return [];
                const scored = this.scoreVideos(allVideos, history, favorites);
                return this.diversify(scored).slice(0, 50);
            },
            scoreVideos(allVideos, history, favorites) {
                const now = Date.now();
                const maxPlayCount = Math.max(...Array.from(allVideos.values()).map(v => v.playCount || 0), 1);
                allVideos.forEach((video, videoId) => {
                    const isFav = favorites.some(f => f.videoId === videoId);
                    const daysSince = (now - (video.lastPlayed || video.addedAt || now)) / (86400000);
                    let score = (video.playCount || 0) / maxPlayCount * 0.25;
                    score += Math.exp(-daysSince / 7) * 0.25;
                    if ((video.playCount || 0) === 0 && video.source === 'radio') score += 0.4;
                    if (isFav) score *= 1.5;
                    video.score = score + (Math.random() - 0.5) * 0.05;
                });
                return Array.from(allVideos.values()).sort((a, b) => b.score - a.score);
            },
            diversify(videos) { return videos; }
        };

        async function fetchWithRetry(url, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    return await response.json();
                } catch (error) {
                    if (i < maxRetries - 1) await new Promise(resolve => setTimeout(resolve, 500));
                    else throw error;
                }
            }
        }

        function formatTime(sec) {
            const m = Math.floor(sec / 60);
            const s = Math.floor(sec % 60);
            return `${m}:${s < 10 ? '0'+s : s}`;
        }
        function updateIcons(playing) {
            const path = playing ? SVG_PAUSE : SVG_PLAY;
            document.getElementById('play-icon-desktop').innerHTML = path;
            document.getElementById('play-icon-mobile').innerHTML = path;
            document.getElementById('fp-play-icon').innerHTML = path;
            if ('mediaSession' in navigator) navigator.mediaSession.playbackState = playing ? "playing" : "paused";
        }
        function updateNavButtons() {
            const hasQueue = currentQueue.length > 0;
            ['prev-btn', 'next-btn', 'mobile-prev-btn', 'mobile-next-btn', 'fp-prev-btn', 'fp-next-btn'].forEach(id => {
                const btn = document.getElementById(id); if(btn) { btn.disabled = !hasQueue; btn.style.opacity = hasQueue ? '1' : '0.3'; }
            });
        }
        function updateLoveButton() {
            if (currentIndex === -1 || !currentQueue[currentIndex]) return;
            const videoId = currentQueue[currentIndex].videoId;
            const isLoved = StorageManager.isFavorite(videoId);
            ['love-btn', 'mobile-love-btn', 'fp-love-btn'].forEach(id => { const btn = document.getElementById(id); if (btn) btn.classList.toggle('loved', isLoved); });
        }
        function updateOpenInYtButton(videoId) {
            const btn = document.getElementById('open-yt-btn'), fpBtn = document.getElementById('fp-yt-btn');
            if(videoId) { const url = `https://www.youtube.com/watch?v=${videoId}`; btn.href = url; fpBtn.onclick = () => window.open(url, '_blank'); }
        }
        function updateViewModeButtons() {
            const gridBtn = document.getElementById('view-grid-btn'), listBtn = document.getElementById('view-list-btn');
            if (!gridBtn || !listBtn) return;
            if (viewMode === 'grid') { gridBtn.classList.add('bg-white/10', 'text-white'); gridBtn.classList.remove('text-gray-400'); listBtn.classList.remove('bg-white/10', 'text-white'); listBtn.classList.add('text-gray-400'); }
            else { listBtn.classList.add('bg-white/10', 'text-white'); listBtn.classList.remove('text-gray-400'); gridBtn.classList.remove('bg-white/10', 'text-white'); gridBtn.classList.add('text-gray-400'); }
        }
        function updateMediaSession(track) {
            if ('mediaSession' in navigator) {
                const thumb = track.thumbnail || (track.thumbnails ? track.thumbnails[0].url : '');
                navigator.mediaSession.metadata = new MediaMetadata({ title: track.title, artist: track.channel, artwork: [{ src: thumb, sizes: '512x512', type: 'image/jpeg' }] });
                navigator.mediaSession.setActionHandler('play', playVideo); navigator.mediaSession.setActionHandler('pause', pauseVideo);
                navigator.mediaSession.setActionHandler('previoustrack', prevTrack); navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
                navigator.mediaSession.setActionHandler('seekto', (details) => { if (player && player.seekTo) player.seekTo(details.seekTime, true); });
            }
        }

        var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
        document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, document.getElementsByTagName('script')[0]);

        function onYouTubeIframeAPIReady() {
            player = new YT.Player('yt-player', {
                height: '100%', width: '100%',
                playerVars: { playsinline: 1, controls: 0, disablekb: 1, fs: 0, iv_load_policy: 3, modestbranding: 1, autoplay: 1, origin: window.location.origin },
                events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange, onError: onPlayerError }
            });
        }
        function onPlayerReady(event) {
            isPlayerReady = true; player.setPlaybackQuality('small');
            const settings = StorageManager.getSettings(); setVideoSize(settings.videoSize);
            if (pendingPlayIndex !== -1) { loadTrack(pendingPlayIndex); pendingPlayIndex = -1; }
        }
        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) { isPlaying = true; updateIcons(true); startProgressLoop(); }
            else if (event.data === YT.PlayerState.PAUSED) { isPlaying = false; updateIcons(false); stopProgressLoop(); }
            else if (event.data === YT.PlayerState.ENDED) { isPlaying = false; updateIcons(false); nextTrack(); }
        }
        function onPlayerError(event) { if (event.data === 150 || event.data === 101) setTimeout(nextTrack, 1000); }

        function loadTrack(index) {
            if (!currentQueue[index]) return;
            if (!isPlayerReady) { pendingPlayIndex = index; return; }
            currentIndex = index; const track = currentQueue[index];
            const thumb = track.thumbnail || (track.thumbnails ? track.thumbnails[0].url : 'https://placehold.co/48x48/333/666?text=Music');
            document.getElementById('player-title').innerText = track.title; document.getElementById('player-artist').innerText = track.channel; document.getElementById('player-art').src = thumb;
            document.getElementById('fp-title').innerText = track.title; document.getElementById('fp-artist').innerText = track.channel; document.getElementById('fp-art-img').src = thumb;
            player.loadVideoById(track.videoId); updateOpenInYtButton(track.videoId);
            StorageManager.addPlay(track); updateLoveButton(); renderQueue(); updateNavButtons(); updateMediaSession(track);
        }
        function playVideo() { if (isPlayerReady) player.playVideo(); }
        function pauseVideo() { if (isPlayerReady) player.pauseVideo(); }
        function togglePlay() { isPlaying ? pauseVideo() : playVideo(); }
        function nextTrack() { if (currentQueue.length > 0) loadTrack((currentIndex + 1) >= currentQueue.length ? 0 : currentIndex + 1); }
        function prevTrack() { if (currentQueue.length > 0) loadTrack((currentIndex - 1) < 0 ? currentQueue.length - 1 : currentIndex - 1); }
        function startProgressLoop() {
            if (updateInterval) clearInterval(updateInterval);
            updateInterval = setInterval(() => {
                if (!player || !player.getCurrentTime) return;
                const curr = player.getCurrentTime(), total = player.getDuration();
                if (total > 0) {
                    const pct = (curr / total) * 100;
                    ['desktop-progress-bar', 'mobile-progress-bar', 'fp-progress-bar'].forEach(id => { const el = document.getElementById(id); if(el) el.style.width = pct + '%'; });
                    if(document.getElementById('desktop-progress-thumb')) document.getElementById('desktop-progress-thumb').style.left = pct + '%';
                    const tStr = formatTime(curr), dStr = formatTime(total);
                    document.getElementById('current-time').innerText = tStr; document.getElementById('total-duration').innerText = dStr;
                    document.getElementById('fp-current-time').innerText = tStr; document.getElementById('fp-total-duration').innerText = dStr;
                }
            }, 500);
        }
        function stopProgressLoop() { clearInterval(updateInterval); }
        function seekTo(e, container) {
            if (!isPlayerReady || player.getDuration() === 0) return;
            const rect = container.getBoundingClientRect(), pct = (e.clientX - rect.left) / rect.width;
            player.seekTo(player.getDuration() * pct, true);
        }

        async function playSearchItem(video) {
            currentQueue = [video]; loadTrack(0); StorageManager.addToQueue({ videoId: video.videoId, title: video.title, channel: video.channel }, 'search');
            try {
                const radioAPI = getRandomAPI(RADIO_APIS); const res = await fetchWithRetry(`${radioAPI}?videoId=${video.videoId}`);
                if (res.videos && res.videos.length > 0) { res.videos.forEach(v => { StorageManager.addToQueue({ videoId: v.videoId, title: v.title, channel: v.channel }, 'radio'); currentQueue.push(v); }); renderQueue(); }
            } catch (e) { console.warn("Radio fail"); }
        }

        async function performSearch(query) {
            if (!query) return;
            document.getElementById('content-section').innerHTML = `<h2 class="text-2xl font-bold mb-4">Searching "${query}"...</h2><div id="results-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">${new Array(12).fill('<div class="p-3 rounded-xl"><div class="aspect-square rounded-lg skeleton mb-3"></div><div class="h-4 w-3/4 rounded skeleton mb-2"></div><div class="h-3 w-1/2 rounded skeleton"></div></div>').join('')}</div>`;
            try {
                const searchAPI = getRandomAPI(SEARCH_APIS); const res = await fetchWithRetry(`${searchAPI}?q=${encodeURIComponent(query)}`);
                lastResults = res.results || []; StorageManager.addSearch(query);
                document.getElementById('content-section').innerHTML = `
                    <div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold">Results for "${query}"</h2><div class="flex bg-[#212121] rounded-lg p-1"><button id="view-grid-btn" onclick="setViewMode('grid')" class="p-2 rounded-md"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg></button><button id="view-list-btn" onclick="setViewMode('list')" class="p-2 rounded-md"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button></div></div>
                    <div id="results-grid"></div>
                `;
                renderSearchResults(); updateViewModeButtons();
            } catch (e) { document.getElementById('content-section').innerHTML = `<p class="text-red-500">Error fetching results.</p>`; }
        }

        function renderGenericGrid(containerId, videos, isRemovable = false) {
            const grid = document.getElementById(containerId);
            if (!grid) return;
            grid.innerHTML = '';
            
            if (viewMode === 'grid') {
                grid.className = "grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4";
                videos.forEach(vid => {
                    if (vid.duration && (vid.duration.includes('m') || vid.duration.includes('h'))) return;
                    const div = document.createElement('div');
                    div.className = "group relative p-4 rounded-xl hover:bg-[#282828] transition-all duration-300 ease-out cursor-pointer";
                    div.onclick = () => playSearchItem(vid);
                    div.innerHTML = `
                        <div class="relative aspect-square rounded-lg overflow-hidden mb-3 shadow-lg">
                            <img src="${vid.thumbnail}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" loading="lazy">
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex items-center justify-center backdrop-blur-[2px]">
                                <div class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center transform translate-y-4 group-hover:translate-y-0 transition-transform duration-300 shadow-xl hover:scale-110">
                                    <svg class="w-6 h-6 ml-1" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                                </div>
                            </div>
                            ${vid.duration ? `<div class="absolute bottom-2 right-2 bg-black/80 backdrop-blur-md px-1.5 py-0.5 rounded text-[10px] font-bold text-white shadow-sm">${vid.duration}</div>` : ''}
                        </div>
                        <h4 class="font-bold text-white text-sm truncate mb-1 group-hover:text-white transition-colors">${vid.title}</h4>
                        <p class="text-xs text-gray-400 font-medium truncate group-hover:text-gray-300 transition-colors">${vid.channel}</p>
                        ${isRemovable ? `<button class="absolute top-2 right-2 p-1.5 bg-black/60 hover:bg-red-500/80 rounded-full opacity-0 group-hover:opacity-100 transition-all z-20" onclick="event.stopPropagation(); removeVideo('${vid.videoId}')"><svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>` : ''}
                    `;
                    grid.appendChild(div);
                });
            } else {
                grid.className = "space-y-2";
                videos.forEach(vid => {
                    const div = document.createElement('div');
                    div.className = "flex items-center space-x-4 p-3 rounded-xl hover:bg-[#1a1a1a] cursor-pointer group relative";
                    div.onclick = () => playSearchItem(vid);
                    div.innerHTML = `
                        <div class="relative flex-shrink-0 w-20 h-20 sm:w-24 sm:h-24">
                            <img src="${vid.thumbnail}" class="w-full h-full rounded-lg object-cover">
                            <div class="absolute inset-0 bg-black/40 hidden group-hover:flex items-center justify-center rounded-lg">
                                <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-semibold text-base truncate text-white mb-1">${vid.title}</h4>
                            <p class="text-sm text-gray-400 truncate">${vid.channel}</p>
                        </div>
                        ${vid.duration ? `<div class="text-xs text-gray-500 font-medium">${vid.duration}</div>` : ''}
                        ${isRemovable ? `<button class="p-2 hover:bg-red-500/20 rounded-full opacity-0 group-hover:opacity-100 transition-all ml-2" onclick="event.stopPropagation(); removeVideo('${vid.videoId}')"><svg class="w-5 h-5 text-gray-400 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>` : ''}
                    `;
                    grid.appendChild(div);
                });
            }
        }

        function removeVideo(videoId) {
            if(confirm("Remove this song? It won't appear in recommendations again.")) {
                StorageManager.addToBlacklist(videoId);
                renderHomeFeed();
            }
        }

        function renderSearchResults() { renderGenericGrid('results-grid', lastResults); }

        function renderHomeFeed() {
            const section = document.getElementById('content-section');
            const history = StorageManager.getHistory();
            const blacklist = StorageManager.getBlacklist();
            
            // Filter Listen Again (History)
            const listenAgain = history.plays
                .filter(p => !blacklist.includes(p.videoId))
                .slice(0, 18)
                .map(p => ({...p, thumbnail: StorageManager.getThumbnailUrl(p.videoId)}));

            // Generate For You
            const forYou = FeedGenerator.generate();

            section.innerHTML = `
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-3xl font-bold tracking-tight">Home</h2>
                    <div class="flex bg-[#212121] rounded-lg p-1">
                        <button id="view-grid-btn" onclick="setViewMode('grid')" class="p-2 rounded-md transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg></button>
                        <button id="view-list-btn" onclick="setViewMode('list')" class="p-2 rounded-md transition"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button>
                    </div>
                </div>

                ${listenAgain.length > 0 ? `
                <div class="mb-10">
                    <div class="flex items-center space-x-2 mb-4">
                        <svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h3 class="text-xl font-bold">Listen Again</h3>
                    </div>
                    <div id="listen-again-grid"></div>
                </div>` : ''}

                <div>
                    <div class="flex items-center space-x-2 mb-4">
                         <svg class="w-6 h-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        <h3 class="text-xl font-bold">For You</h3>
                    </div>
                    <div id="for-you-grid"></div>
                </div>
            `;
            
            updateViewModeButtons();
            if(listenAgain.length > 0) renderGenericGrid('listen-again-grid', listenAgain, true);
            renderGenericGrid('for-you-grid', forYou, true);
        }

        function renderFavorites() {
            const section = document.getElementById('content-section');
            const favorites = StorageManager.getFavorites();
            section.innerHTML = `
                <div class="flex items-center justify-between mb-6"><div><h2 class="text-2xl font-bold">Favorites</h2><p class="text-sm text-gray-400 mt-1">${favorites.length} songs</p></div><div class="flex bg-[#212121] rounded-lg p-1"><button id="view-grid-btn" onclick="setViewMode('grid')" class="p-2 rounded-md"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M4 11h5V5H4v6zm0 7h5v-6H4v6zm6 0h5v-6h-5v6zm6 0h5v-6h-5v6zm-6-7h5V5h-5v6zm6-6v6h5V5h-5z"/></svg></button><button id="view-list-btn" onclick="setViewMode('list')" class="p-2 rounded-md"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg></button></div></div>
                <div id="favorites-grid"></div>
            `;
            const mappedFavs = favorites.reverse().map(f => ({...f, thumbnail: StorageManager.getThumbnailUrl(f.videoId)}));
            updateViewModeButtons();
            renderGenericGrid('favorites-grid', mappedFavs);
        }

        function renderQueue() {
            const list = document.getElementById('queue-list');
            document.getElementById('queue-count').textContent = `${currentQueue.length} song${currentQueue.length !== 1 ? 's' : ''} in queue`;
            list.innerHTML = '';
            currentQueue.forEach((vid, i) => {
                const el = document.createElement('div');
                const isActive = i === currentIndex;
                el.className = `queue-item group flex items-center space-x-3 p-3 rounded-lg cursor-pointer transition-all ${isActive ? 'active text-white bg-[#212121]' : 'text-gray-300 hover:bg-[#1a1a1a]'}`;
                el.onclick = () => loadTrack(i);
                const thumb = vid.thumbnail || (vid.thumbnails ? vid.thumbnails[0].url : '');
                el.innerHTML = `<div class="w-6 text-center text-xs font-bold text-gray-500">${isActive ? '' : i+1}</div><img src="${thumb}" class="w-10 h-10 rounded bg-[#333] object-cover"><div class="flex-1 min-w-0"><p class="text-sm font-semibold truncate">${vid.title}</p><p class="text-xs text-gray-400 truncate">${vid.channel}</p></div><button class="opacity-0 group-hover:opacity-100 p-2 hover:text-red-500" onclick="event.stopPropagation(); removeFromQueue(${i})">x</button>`;
                list.appendChild(el);
            });
        }
        function removeFromQueue(index) {
            if (index === currentIndex) nextTrack(); else if (index < currentIndex) currentIndex--;
            currentQueue.splice(index, 1); renderQueue();
        }
        function setViewMode(mode) {
            viewMode = mode; StorageManager.setViewMode(mode);
            if (currentView === 'home') renderHomeFeed(); else if (currentView === 'favorites') renderFavorites(); else if (currentView === 'search') renderSearchResults();
        }
        function toggleQueue() { document.getElementById('queue-panel').classList.toggle('translate-x-full'); }
        function toggleSettings() { document.getElementById('settings-modal').classList.toggle('hidden'); }
        function setVideoSize(size) { document.getElementById('video-wrapper').style.width = size + 'px'; document.getElementById('size-value').innerText = size + 'px'; }
        function toggleFullPlayer() {
            const overlay = document.getElementById('full-player-overlay'); isFullPlayerOpen = !isFullPlayerOpen;
            if (isFullPlayerOpen) overlay.classList.remove('translate-y-full'); else { overlay.classList.add('translate-y-full'); setFullPlayerMode('art'); }
        }
        function setFullPlayerMode(mode) {
            fullPlayerMode = mode; const videoWrapper = document.getElementById('video-wrapper'), artBtn = document.getElementById('fp-mode-art'), vidBtn = document.getElementById('fp-mode-video');
            if (mode === 'video') {
                videoWrapper.classList.add('video-wrapper-full'); videoWrapper.classList.remove('video-hidden'); videoWrapper.classList.add('video-visible'); isVideoVisible = true;
                vidBtn.classList.remove('text-gray-400'); vidBtn.classList.add('bg-white/10', 'text-white'); artBtn.classList.add('text-gray-400'); artBtn.classList.remove('bg-white/10', 'text-white');
            } else {
                videoWrapper.classList.remove('video-wrapper-full'); if(!isVideoVisible) { videoWrapper.classList.add('video-hidden'); videoWrapper.classList.remove('video-visible'); }
                artBtn.classList.remove('text-gray-400'); artBtn.classList.add('bg-white/10', 'text-white'); vidBtn.classList.add('text-gray-400'); vidBtn.classList.remove('bg-white/10', 'text-white');
            }
        }
        function toggleDesktopSidebar() {
            const sidebar = document.getElementById('sidebar'), settings = StorageManager.getSettings();
            sidebar.classList.toggle('sidebar-collapsed'); settings.sidebarCollapsed = sidebar.classList.contains('sidebar-collapsed');
            StorageManager.saveSettings(settings);
        }

        document.addEventListener('DOMContentLoaded', () => {
            viewMode = StorageManager.getViewMode();
            const savedSettings = StorageManager.getSettings();
            if(savedSettings.sidebarCollapsed) document.getElementById('sidebar').classList.add('sidebar-collapsed');
            document.getElementById('player-size-slider').value = savedSettings.videoSize || 320;

            document.getElementById('search-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.target.value.trim()) {
                    currentView = 'search'; document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); performSearch(e.target.value.trim());
                }
            });

            ['home', 'explore', 'favorites'].forEach(view => {
                document.getElementById('nav-' + view).onclick = (e) => {
                    e.preventDefault(); currentView = view;
                    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active')); document.getElementById('nav-' + view).classList.add('active');
                    if(view === 'home') renderHomeFeed(); else if(view === 'favorites') renderFavorites();
                    else if(view === 'explore') document.getElementById('content-section').innerHTML = '<h2 class="text-2xl font-bold">Explore</h2><p class="text-gray-400">Search for music to get started.</p>';
                    if(window.innerWidth < 640) { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); }
                }
            });

            document.getElementById('menu-btn').onclick = () => { document.getElementById('sidebar').classList.remove('-translate-x-full'); document.getElementById('sidebar-overlay').classList.remove('hidden'); };
            const closeSidebar = () => { document.getElementById('sidebar').classList.add('-translate-x-full'); document.getElementById('sidebar-overlay').classList.add('hidden'); };
            document.getElementById('close-sidebar-btn').onclick = closeSidebar; document.getElementById('sidebar-overlay').onclick = closeSidebar;
            document.getElementById('play-pause-btn').onclick = togglePlay; document.getElementById('mobile-play-btn').onclick = togglePlay; document.getElementById('fp-play-btn').onclick = togglePlay;
            document.getElementById('next-btn').onclick = nextTrack; document.getElementById('prev-btn').onclick = prevTrack;
            document.getElementById('mobile-next-btn').onclick = nextTrack; document.getElementById('mobile-prev-btn').onclick = prevTrack; document.getElementById('fp-next-btn').onclick = nextTrack; document.getElementById('fp-prev-btn').onclick = prevTrack;
            const seekHandler = (e, id) => seekTo(e, document.getElementById(id));
            document.getElementById('desktop-progress-container').onclick = (e) => seekHandler(e, 'desktop-progress-container');
            document.getElementById('mobile-progress-container').onclick = (e) => seekHandler(e, 'mobile-progress-container');
            document.getElementById('fp-progress-container').onclick = (e) => seekHandler(e, 'fp-progress-container');
            document.getElementById('queue-btn').onclick = toggleQueue; document.getElementById('close-queue-btn').onclick = toggleQueue;
            document.getElementById('clear-queue-btn').onclick = () => { currentQueue = []; currentIndex = -1; renderQueue(); };
            document.getElementById('shuffle-queue-btn').onclick = () => { /* Shuffle logic */ };
            const toggleVideoUI = () => {
                isVideoVisible = !isVideoVisible; const wrapper = document.getElementById('video-wrapper'), btn = document.getElementById('toggle-video-btn');
                wrapper.classList.toggle('video-hidden', !isVideoVisible); wrapper.classList.toggle('video-visible', isVideoVisible);
                btn.classList.toggle('text-red-500', isVideoVisible); btn.classList.toggle('border-red-500', isVideoVisible);
            };
            document.getElementById('toggle-video-btn').onclick = toggleVideoUI; document.getElementById('hide-video-btn').onclick = toggleVideoUI;
            const loveHandler = () => { if (currentIndex === -1) return; StorageManager.toggleFavorite(currentQueue[currentIndex]); updateLoveButton(); if (currentView === 'favorites') renderFavorites(); if (currentView === 'home') renderHomeFeed(); };
            document.getElementById('love-btn').onclick = loveHandler; document.getElementById('mobile-love-btn').onclick = loveHandler; document.getElementById('fp-love-btn').onclick = loveHandler;
            document.getElementById('nav-settings').onclick = toggleSettings; document.getElementById('fp-settings-btn').onclick = toggleSettings; document.getElementById('close-settings-btn').onclick = toggleSettings;
            document.getElementById('player-size-slider').oninput = (e) => { setVideoSize(e.target.value); const settings = StorageManager.getSettings(); settings.videoSize = e.target.value; StorageManager.saveSettings(settings); };
            document.getElementById('full-player-btn').onclick = toggleFullPlayer; document.getElementById('close-full-player-btn').onclick = toggleFullPlayer;
            document.getElementById('player-art').onclick = toggleFullPlayer; document.getElementById('player-info-area').onclick = toggleFullPlayer;
            document.getElementById('fp-mode-art').onclick = () => setFullPlayerMode('art'); document.getElementById('fp-mode-video').onclick = () => setFullPlayerMode('video');
            document.getElementById('desktop-sidebar-toggle').onclick = toggleDesktopSidebar;

            renderHomeFeed();
        });
    </script>
</body>
</html>
